---
title: "tidyr-101"
author: "Rodrigo"
format: html
---

```{r}
#| message: false
here::i_am("dm-course-git-101.Rproj")
library(here)
```

```{r}

#| message: false

library(ggplot2)

library(dplyr)
library(tidyr)
```


```{r}
data("EuStockMarkets")
```

```{r}
ggplot(EuStockMarkets, aes(y=DAX,x=time(EuStockMarkets))) +
  geom_line()
```

```{r}
EuStockMarkets <- 
  EuStockMarkets |>
    as_tibble() |>
    mutate(date=as.numeric(time(EuStockMarkets)))
```

```{r}
ggplot(EuStockMarkets, aes(y=DAX,x=date)) +
  geom_line()
```

```{r}
ggplot(EuStockMarkets,aes(y=CAC,x=date))+
  geom_line()
```



```{r}
ggplot(EuStockMarkets,aes(y=CAC,x=date))+
  geom_line(color="steelblue")+
  geom_line(mapping = aes(y=DAX),color="salmon")
```

### Tidyr Solution

```{r}
EuStockMarkets |>
  pivot_longer(!date, names_to="index") |>
  slice_head(n=10) |>
  knitr::kable()

```

```{r}
EuStockMarkets |>
  pivot_longer(!date, names_to="index") |>
  ggplot(aes(x=date, y=value, colour=index))+
  geom_line()
```

### More pivoting

```{r}
EuStockMarkets |>
  pivot_longer(everything())|>
   slice_head(n=10) |>
  knitr::kable()

```


```{r}
EuStockMarkets |>
  pivot_longer(DAX|SMI)|>
   slice_head(n=10) |>
  knitr::kable()
```


```{r}
EuStockMarkets |>
  select(!FTSE) |>
  pivot_longer(!date)|>summarise(avg_stock=mean(value),.by = date) |>
  slice_head(n=10) |>
  knitr::kable()
```

```{r}
EuStockMarkets|>
  select(!FTSE)|>
  rowwise() |>
  summarise(date, avg_stock=mean(DAX,SMI,CAC))
```


### Reverse op pivot to a wider format



```{r}
Eulong <- EuStockMarkets |> pivot_longer(!date)
```

```{r}
Eulong|>pivot_wider()
```


```{r}
Eulong|>pivot_wider(id_cols = date) |>
  slice_head(n=10)|>
  knitr::kable()
```



```{r}
data("diamonds")
dgroup <- diamonds|>summarise(count=n(),median_price=median(price),.by=c(cut,color))
```

```{r}
dgroup|>
  select(!count)|>
  pivot_wider(id_cols = cut, names_from=color,values_from = median_price)
```

